'use strict';const lat=47.519124,lng=-2.856659,params="waveHeight,swellDirection,windSpeed,windDirection,airTemperature,cloudCover,humidity,precipitation",start=(new Date((new Date).setHours(0,0,0,0))).toISOString(),end=(new Date((new Date).setHours(23,59,59,999))).toISOString(),now=(new Date).toISOString(),token="6db0f846-9ab7-11ea-a27e-0242ac130002-6db0f8fa-9ab7-11ea-a27e-0242ac130002";let weatherReady=!1,tideSeaReady=!1,tideExtremesReady=!1,astronomyReady=!1;
Array.prototype.max=function(){return Math.max.apply(null,this)};Array.prototype.min=function(){return Math.min.apply(null,this)};Array.prototype.avg=function(){return this.reduce((h,k)=>new Number(h)+new Number(k))/this.length};function isEmpty(h){for(var k in h)if(h.hasOwnProperty(k))return!1;return!0}function fetchReady(){return weatherReady&&tideSeaReady&&tideExtremesReady&&astronomyReady}
function degToCompass(h){return"N NNE NE ENE E ESE SE SSE S SSW SW WSW W WNW NW NNW".split(" ")[Math.floor(h/22.5+.5)%16]}
document.addEventListener("DOMContentLoaded",function(){function h(b){let c=[];var g=document.querySelector("#waveHeight");let l=[];const u=document.querySelector("#waveHeightTimes");let r=[];const v=document.querySelector("#windSpeedTime");let w=[];const D=document.querySelector("#swellDirection");let m=[];const E=document.querySelector("#windSpeed");let x=[];const F=document.querySelector("#windDirection");let n=[];const G=document.querySelector("#airTemperature");let y=[];const H=document.querySelector("#cloudCover");
let z=[];const I=document.querySelector("#humidity");let A=[],B=[],C=[];const J=document.querySelector("#precipitation");b.hours.forEach(function(a){let d=0,e=0;for(const [,f]of Object.entries(a.waveHeight))d+=f,e++;c.push((d/e).toFixed(2));l.push({height:(d/e).toFixed(2),time:a.time})});l=l.filter(function(a){if(a.height==c.min())return a.type="low",a;if(a.height==c.max())return a.type="high",a});l.forEach(function(a){u.innerHTML+=`<li>
                                        <div>${a.height}m<span>${"high"==a.type?"Haute":"Basse"}</span><span>${(new Date(a.time)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span></div>
                                    </li>`});g.innerHTML=c.min()+" - "+c.max()+"<span>m</span>";b.hours.forEach(function(a){let d=0,e=0;for(const [,f]of Object.entries(a.swellDirection))d+=f,e++;w.push((d/e).toFixed(2))});D.innerHTML=degToCompass(w.avg().toFixed(2));b.hours.forEach(function(a){let d=0,e=0,f=0;for(const [,t]of Object.entries(a.windDirection))d+=t,f++;for(const [,t]of Object.entries(a.windSpeed))e+=t;x.push((d/f).toFixed(2));m.push((e/f*1.944).toFixed(2));r.push({direction:(d/f).toFixed(2),
speed:(e/f*1.944).toFixed(2),time:a.time})});E.innerHTML=`${m.avg().toFixed(0)}<span>kt</span>`;F.innerHTML=degToCompass(x.avg());r.filter(function(a){if(a.speed==m.min())return a.type="low",a;if(a.speed==m.max())return a.type="high",a}).forEach(function(a){v.innerHTML+=`<li>
                                        <div>${a.speed}kt<span>${degToCompass(a.direction)}</span><span>${"high"==a.type?"Haute":"Basse"}</span><span>${(new Date(a.time)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span></div>
                                    </li>`});A=r.map(function(a){return(new Date(a.time)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});g=document.getElementById("windPrevision").getContext("2d");new Chart(g,{type:"bar",data:{labels:A,datasets:[{label:"Vitesse",data:m,backgroundColor:"#5e72e4",order:2},{label:"Vitesse moyenne",data:m,type:"line",order:1,borderColor:"#5e72e4"}]},options:{legend:{labels:{fontColor:"white"}},scales:{yAxes:[{ticks:{fontColor:"white"}}],xAxes:[{ticks:{fontColor:"white"}}]}}});
b.hours.forEach(function(a){let d=0,e=0;for(const [,f]of Object.entries(a.airTemperature))d+=f,e++;n.push((d/e).toFixed(0));B.push((new Date(a.time)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))});G.innerHTML=n.min().toFixed(0)+" - "+n.max().toFixed(0)+"\u00b0";g=document.getElementById("TemperaturePrevision").getContext("2d");new Chart(g,{type:"line",data:{labels:B,datasets:[{label:"Temperature",data:n,borderColor:"#5e72e4",order:2}]},options:{legend:{labels:{fontColor:"white"}},scales:{yAxes:[{ticks:{fontColor:"white",
stepSize:1,beginAtZero:!0}}],xAxes:[{ticks:{fontColor:"white"}}]}}});b.hours.forEach(function(a){let d=0,e=0;for(const [,f]of Object.entries(a.cloudCover))d+=f,e++;y.push((d/e).toFixed(2))});H.innerHTML=y.avg().toFixed(0)+"%";b.hours.forEach(function(a){let d=0,e=0;for(const [,f]of Object.entries(a.humidity))d+=f,e++;z.push((d/e).toFixed(2))});I.innerHTML=z.avg().toFixed(0)+"%";b.hours.forEach(function(a){let d=0,e=0;for(const [,f]of Object.entries(a.precipitation))d+=f,e++;C.push((d/e).toFixed(2))});
J.innerHTML=C.avg().toFixed(0)+"kg/m\u00b2";weatherReady=!0}function k(b){document.querySelector("#astronomy").innerHTML=`${(new Date(b.data[0].sunrise)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})} - ${(new Date(b.data[0].sunset)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`;astronomyReady=!0}function p(b){const c=document.querySelector("#tideExtreme");b.data.forEach(function(g){c.innerHTML+=`<li>
                                        <div>${g.height.toFixed(2)}m<span>${"high"==g.type?"Haute":"Basse"}</span><span>${(new Date(g.time)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span></div>
                                    </li>`});tideExtremesReady=!0}function q(b){let c=[],g=[];b.data.forEach(function(l){c.push(l.sg.toFixed(2))});b.data.forEach(function(l){g.push((new Date(l.time)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))});b=document.getElementById("tidePrevision").getContext("2d");new Chart(b,{type:"bar",data:{labels:g,datasets:[{label:"Hauteur",data:c,backgroundColor:"#5e72e4",order:2},{label:"Hauteur moyen",data:c,type:"line",order:1,borderColor:"#5e72e4"}]},
options:{legend:{labels:{fontColor:"white"}},scales:{yAxes:[{ticks:{fontColor:"white"}}],xAxes:[{ticks:{fontColor:"white"}}]}}});tideSeaReady=!0}fetch("api/getWeather.php?data_timestamp="+start.slice(0,19).replace("T"," ")).then(b=>b.json()).then(b=>{isEmpty(b)?fetch(`https://api.stormglass.io/v2/weather/point?lat=${lat}&lng=${lng}&params=${params}&start=${start}&end=${end}`,{headers:{Authorization:token}}).then(c=>c.json()).then(c=>{h(c);fetch("api/setWeather.php?data_timestamp="+start.slice(0,19).replace("T",
" "),{method:"POST",body:JSON.stringify(c)})}):h(b)});fetch("api/getTideSea.php?data_timestamp="+start.slice(0,19).replace("T"," ")).then(b=>b.json()).then(b=>{isEmpty(b)?fetch(`https://api.stormglass.io/v2/tide/sea-level/point?lat=${lat}&lng=${lng}&start=${start}&end=${end}`,{headers:{Authorization:token}}).then(c=>c.json()).then(c=>{q(c);fetch("api/setTideSea.php?data_timestamp="+start.slice(0,19).replace("T"," "),{method:"POST",body:JSON.stringify(c)})}):q(b)});fetch("api/getTideExtremes.php?data_timestamp="+
start.slice(0,19).replace("T"," ")).then(b=>b.json()).then(b=>{isEmpty(b)?fetch(`https://api.stormglass.io/v2/tide/extremes/point?lat=${lat}&lng=${lng}&start=${start}&end=${end}`,{headers:{Authorization:token}}).then(c=>c.json()).then(c=>{p(c);fetch("api/setTideExtremes.php?data_timestamp="+start.slice(0,19).replace("T"," "),{method:"POST",body:JSON.stringify(c)})}):p(b)});fetch("api/getAstronomy.php?data_timestamp="+start.slice(0,19).replace("T"," ")).then(b=>b.json()).then(b=>{isEmpty(b)?fetch(`https://api.stormglass.io/v2/astronomy/point?lat=${lat}&lng=${lng}&end=${end}`,
{headers:{Authorization:token}}).then(c=>c.json()).then(c=>{k(c);fetch("api/setAstronomy.php?data_timestamp="+start.slice(0,19).replace("T"," "),{method:"POST",body:JSON.stringify(c)})}):k(b)})});
document.addEventListener("DOMContentLoaded",function(){const h=(new Date).toLocaleString(),k=document.querySelector("#timedata"),p=document.querySelector("#report");k.innerHTML=h;document.onreadystatechange=function(){var q=setInterval(()=>{"complete"==document.readyState&&fetchReady()&&(p.classList.add("is-active"),clearInterval(q))},20)}});